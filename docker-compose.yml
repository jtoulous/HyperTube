services:
  backend:
    build: ./backend
    container_name: hypertube-backend
    ports:
      - "0.0.0.0:8000:8000"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-hypertube}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_DB=${POSTGRES_DB:-hypertube}
      - JWT_SECRET=${JWT_SECRET:-dev_secret_key}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - MAIL_FROM=${MAIL_FROM}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME}
      - HOST_IP=${HOST_IP}
      - FORTYTWO_UID=${FORTYTWO_UID}
      - FORTYTWO_SECRET=${FORTYTWO_SECRET}
      - GITHUB_UID=${GITHUB_UID}
      - GITHUB_SECRET=${GITHUB_SECRET}
      - DISCORD_UID=${DISCORD_UID}
      - DISCORD_SECRET=${DISCORD_SECRET}
      - QBITTORRENT_URL=http://hypertube-torrent-client:8080
    command: ["postgres", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    depends_on:
      - database
      - torrent-client
    volumes:
      - ./backend:/app
      - torrent_downloads:/downloads
      - ./torrent-client/default-videos:/default-videos:ro
    restart: always

  frontend:
    build: ./frontend
    container_name: hypertube-frontend
    ports:
      - "0.0.0.0:8081:8081"
    environment:
      - VITE_FORTYTWO_UID=${FORTYTWO_UID}
      - VITE_GITHUB_UID=${GITHUB_UID}
      - VITE_DISCORD_UID=${DISCORD_UID}
      - HOST_IP=${HOST_IP}
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    stdin_open: true
    tty: true
    restart: unless-stopped

  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: hypertube-jackett
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
      - AUTO_UPDATE=true
    volumes:
      - ./jackett:/config/Jackett
    ports:
      - "0.0.0.0:9117:9117"
    restart: unless-stopped

  database:
    build: ./database
    container_name: hypertube-database
    hostname: postgres
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_DB=${POSTGRES_DB:-hypertube}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  torrent-client:
    build: ./torrent-client
    container_name: hypertube-torrent-client
    ports:
      - "127.0.0.1:8080:8080"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - WEBUI_PORT=8080
      - QBITTORRENT_USER=${QBITTORRENT_USER:-admin}
      - QBITTORRENT_PASS=${QBITTORRENT_PASS:-adminadmin}
    volumes:
      - torrent_client_config:/config
      - torrent_downloads:/downloads
      - ./torrent-client/default-videos:/downloads:ro
    restart: unless-stopped

volumes:
  torrent_client_config:
    driver: local
  torrent_downloads:
    driver: local
  postgres_data:
    driver: local
  frontend_node_modules:
    driver: local

